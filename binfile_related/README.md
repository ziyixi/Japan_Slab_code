# binfile_related

## Introduction

This directory contains all the scripts and programs related to the bin files generated by xmeshfem3D of Specfem3D-globe. The main developing language is Julia. Python and Fortran are also used.

## Environment setting

1. Download Julia and Julia packages. From the [download page](https://julialang.org/downloads/), download the appropriate version and platform of Julia. Recommend to download v1.0.5. Unzip the downloaded file and put the bin directory to your system PATH. Type `julia` in the command line, enter the REPL, input `] add <package>`. Users should replace `<package>` with `PyCall`, `NearestNeighbors`, `ArgParse`, `FortranFiles`, `Geodesics`, `MPI` to install all the packages. (Download `PyCall` package may use the conda environment installed, refer to https://github.com/JuliaPy/PyCall.jl for details.)

2. compile the associated fortran files. This fortran files is directly copyed from the Specfem3D globe source code to make life easier. execute binfile_related/specfem_gll.jl/src/fortran/compile.jl with julia: `julia compile.jl`.

## Extract ppm model from the bin files.

1. Refer to binfile_related/extract_ppm_model/slurm_scripts/fwea18_ppm.py to see how to set parameters. Note that you have to change some settings in binfile_related/specfem_gll.jl/src/setting/constants.jl according to your model setting.

2. For the python environment, install the package `slurmpy`. Submit the job, and in the output directory, there will be some text files reccording the ppm info. (refer to line 190-line 211 in binfile_related/specfem_gll.jl/src/program/get_ppm_model.jl for detail, filename is the mpi process id.)

3. Use binfile_related/plot_cross_section/gather_output_2np.py to convert the output files to a single npy file, which could directly be loaded by numpy, the npy file is just a numpy array, and the points is ordered by its position. (three dimensions, if you use np.shape, the output sizes for three dimension is lon,lat,dep)

4. Users can refer to binfile_related/plot_cross_section/plot_profile_np.py to plot the cross section, or just write the script based on the npy files.
